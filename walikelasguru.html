<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Walikelas - SMKN 1 Simpang Teritip</title>
    <!-- Font Awesome untuk Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF & AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --header-height: 60px;
            --sidebar-width: 260px;
            --bg-light: #f4f6f9;
            --navbar-bg: #dc2626; /* Warna Merah untuk Navbar */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Navbar (Custom Red) --- */
        .navbar {
            height: var(--header-height);
            background-color: var(--navbar-bg); /* Menggunakan warna merah */
            display: flex;
            align-items: center;
            padding: 0 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1002;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
            background-color: white; /* Background putih untuk logo agar terlihat jelas */
            border-radius: 50%;
            padding: 2px;
        }

        .navbar-brand span {
            font-weight: 700;
            font-size: 1.1rem;
            color: white; /* Teks putih */
        }

        /* --- Main Content --- */
        .main-content {
            max-width: 1200px; /* Center content on large screens */
            margin: var(--header-height) auto 0;
            padding: 2rem;
            flex: 1;
            overflow-y: auto;
            width: 100%;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .main-content::-webkit-scrollbar {
            display: none;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-info h3 { font-size: 2rem; margin-bottom: 5px; color: #333; }
        .stat-info p { color: #777; font-size: 0.9rem; }
        .stat-icon { font-size: 2.5rem; opacity: 0.2; }

        /* Footer */
        .main-footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 0.85rem;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        /* Overlay */
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .overlay.active {
            display: block;
        }

        /* --- Menu Grid Styles --- */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }
        
        .menu-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px 15px;
            text-align: center;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            height: 100%;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--navbar-bg);
        }
        
        .icon-box {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: white;
            font-size: 1.6rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .menu-card span {
            font-weight: 600;
            font-size: 0.95rem;
            color: #4b5563;
        }
        
        .menu-card:hover span {
            color: var(--navbar-bg);
        }

        @media (max-width: 768px) {
            .navbar-brand span {
                font-size: 1rem;
            }

            /* Penyesuaian Tampilan Mobile untuk Menu Grid */
            .menu-grid {
                grid-template-columns: repeat(2, 1fr); /* Memaksa 2 kolom di layar HP */
                gap: 10px; /* Jarak antar card lebih kecil */
            }

            .menu-card {
                padding: 15px 10px; /* Padding dalam card diperkecil */
            }

            .icon-box {
                width: 45px; /* Ukuran box ikon diperkecil */
                height: 45px;
                font-size: 1.2rem; /* Ukuran ikon font diperkecil */
                margin-bottom: 10px;
            }

            .menu-card span {
                font-size: 0.85rem; /* Ukuran teks diperkecil */
            }
        }

        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; width: 90%; max-width: 400px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: slideDown 0.3s ease; text-align: center; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Tombol Kembali Ke Dashboard */
        .btn-back-dashboard {
            margin-left: auto;
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .btn-back-dashboard:hover {
            background-color: white;
            color: var(--navbar-bg);
        }

        /* Table Styles */
        .table-responsive { 
            overflow-x: auto; 
            overflow-y: auto;
            max-height: 550px; /* Menampilkan sekitar 10 baris data */
            margin-top: 15px; 
        }

        /* Custom Scrollbar for Table */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        /* --- Dark Mode Card & Table Styles --- */
        .card-dark {
            background-color: #1f2937;
            color: #f3f4f6;
            border: 1px solid #374151;
        }
        
        .card-header-dark {
            border-bottom: 1px solid #374151;
        }
        
        .text-muted-dark {
            color: #9ca3af;
        }

        /* Override table styles inside card-dark */
        .card-dark .custom-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0;
            border: 1px solid #374151;
            border-radius: 8px;
            background-color: #1f2937;
        }

        .card-dark .custom-table th {
            background-color: #111827;
            color: #e5e7eb;
            border-bottom: 1px solid #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .card-dark .custom-table td {
            border-bottom: 1px solid #374151;
            color: #d1d5db;
            padding: 15px 20px;
            text-align: left;
        }

        .card-dark .custom-table tr:last-child td {
            border-bottom: none;
        }

        .card-dark .custom-table tr:hover {
            background-color: #374151;
        }
        
        /* Center alignment for No column */
        .card-dark .custom-table th:first-child,
        .card-dark .custom-table td:first-child {
            text-align: center;
            width: 80px;
        }

        /* Stats Grid inside Dark Card */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #111827; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center;
            justify-content: space-between; border: 1px solid #374151;
        }
        .stat-info h3 { font-size: 1.5rem; margin: 0; color: #f3f4f6; }
        .stat-info p { margin: 5px 0 0; color: #9ca3af; font-size: 0.85rem; }
        .stat-icon { font-size: 2rem; opacity: 0.5; }

        /* Attractive Export Button */
        .btn-export {
            background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            transition: all 0.3s ease;
            border: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
        }
        .btn-export i { font-size: 1.1em; }

        /* --- Accordion Styles --- */
        .accordion-item {
            transition: all 0.3s ease;
            border-bottom: 1px solid #374151;
        }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            cursor: pointer;
            user-select: none;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.4s ease, padding 0.4s ease;
            padding: 0 20px;
        }
        .accordion-item.active .accordion-content {
            opacity: 1;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-item.active .accordion-icon { transform: rotate(180deg); }

        /* Small Export Button for Table */
        .btn-sm-export {
            padding: 6px 12px;
            font-size: 0.8rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-sm-export:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <a href="#" class="navbar-brand">
            <img src="" alt="Logo Sekolah" style="display: none;">
            <span></span>
        </a>
        <a href="adminguru.html" class="btn-back-dashboard">Kembali Ke Dashboard</a>
    </nav>

    <!-- Main Content Area -->
    <main class="main-content">
        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
            <div style="background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: #555; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;">
                <i class="far fa-clock" style="color: var(--navbar-bg);"></i>
                <span id="liveDateTime"></span>
            </div>
        </div>

        <!-- Container Biodata Guru (Optional for Walikelas view) -->
        <div class="dashboard-card" id="biodataContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 style="margin: 0; color: #333; font-size: 1.2rem;">
                    <i class="fas fa-id-card" style="color: var(--navbar-bg); margin-right: 10px;"></i>
                    Informasi Walikelas
                </h3>
                <button id="exportLaporanLengkapBtn" class="btn-export" style="font-size: 0.85rem; padding: 8px 15px;">
                    <i class="fas fa-file-pdf"></i> Export Laporan Perkembangan Peserta Didik
                </button>
            </div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start;">
                <div style="flex: 0 0 auto; width: 120px; text-align: center;">
                    <img id="bioPhoto" src="" alt="Foto Guru" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border: 3px solid #eee; background: #f0f0f0;">
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; width: 140px; color: #666; font-weight: 600;">Nama Lengkap</td>
                            <td style="padding: 8px 0; color: #333;">: <span id="bioNama">-</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #666; font-weight: 600;">NIP</td>
                            <td style="padding: 8px 0; color: #333;">: <span id="bioNip">-</span></td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #666; font-weight: 600;">Kelas Ampuan</td>
                            <td style="padding: 8px 0; color: #333;">: <span id="bioKelas" style="font-weight: bold; color: var(--primary-color);">-</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Main Accordion Container -->
        <div class="dashboard-card card-dark" id="mainAccordionContainer" style="display: none; padding: 0; overflow: hidden;">
            
            <!-- 1. Data Siswa Kelas -->
            <div class="accordion-item" id="siswaKelasItem">
                <div class="card-header-dark accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                    <i class="fas fa-users" style="color: #60a5fa; margin-right: 10px;"></i>
                    Data Siswa Kelas <span id="kelasTitle" style="color: #60a5fa; margin-left: 5px;"></span>
                </h3>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="text-muted-dark" style="font-size: 0.9rem;">Total: <span id="totalSiswa" style="font-weight: bold; color: #fff;">0</span> Siswa</div>
                    <i class="fas fa-chevron-down accordion-icon" style="color: #9ca3af;"></i>
                </div>
            </div>
            
            <div class="accordion-content">
                <div class="table-responsive">
                    <table class="custom-table" id="siswaTable">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama Siswa</th>
                            <th>NISN</th>
                            <th>Alamat</th>
                            <th style="text-align: center;">Laporan</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" style="text-align: center;">Memuat data siswa...</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>

            <!-- 2. Rekap Absensi Siswa -->
            <div class="accordion-item" id="absensiKelasItem">
                <div class="card-header-dark accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                    <i class="fas fa-clipboard-list" style="color: #10b981; margin-right: 10px;"></i>
                    Rekap Absensi Siswa
                </h3>
                <i class="fas fa-chevron-down accordion-icon" style="color: #9ca3af;"></i>
            </div>
            
            <div class="accordion-content">
            
            <!-- Stats Cards (Moved inside content) -->
            <div class="stats-grid">
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <div class="stat-info">
                        <h3 id="rekapHadir">0</h3>
                        <p>Total Hadir</p>
                    </div>
                    <i class="fas fa-check-circle stat-icon" style="color: #10b981;"></i>
                </div>
                <div class="stat-card" style="border-left: 4px solid #8b5cf6;">
                    <div class="stat-info">
                        <h3 id="rekapSakit">0</h3>
                        <p>Total Sakit</p>
                    </div>
                    <i class="fas fa-procedures stat-icon" style="color: #8b5cf6;"></i>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f59e0b;">
                    <div class="stat-info">
                        <h3 id="rekapIjin">0</h3>
                        <p>Total Ijin</p>
                    </div>
                    <i class="fas fa-envelope-open-text stat-icon" style="color: #f59e0b;"></i>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ef4444;">
                    <div class="stat-info">
                        <h3 id="rekapAlpa">0</h3>
                        <p>Total Alpa</p>
                    </div>
                    <i class="fas fa-times-circle stat-icon" style="color: #ef4444;"></i>
                </div>
            </div>

            <!-- Search and Export -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                 <div style="display: flex; gap: 10px;">
                    <button id="exportAbsensiPdfBtn" class="btn-export"><i class="fas fa-file-pdf"></i> Export PDF</button>
                </div>
                <div>
                    <input type="text" id="searchAbsensiInput" placeholder="Cari Nama / Ketik Status (Alpa, Sakit...)" style="padding: 8px; border: 1px solid #374151; border-radius: 4px; width: 250px; background-color: #111827; color: white;">
                </div>
            </div>

            <div class="table-responsive">
                <table class="custom-table" id="absensiTable">
                    <thead>
                        <tr>
                            <th style="background-color: #3b82f6; color: white;">No</th>
                            <th style="background-color: #3b82f6; color: white;">Nama Siswa</th>
                            <th style="text-align: center; background-color: #10b981; color: white;">Hadir</th>
                            <th style="text-align: center; background-color: #8b5cf6; color: white;">Sakit</th>
                            <th style="text-align: center; background-color: #f59e0b; color: white;">Ijin</th>
                            <th style="text-align: center; background-color: #ef4444; color: white;">Alpa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center;">Memuat data absensi...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            </div>
        </div>

            <!-- 3. Rekap Piket Umum Siswa -->
            <div class="accordion-item" id="piketKelasItem">
                <div class="card-header-dark accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                    <i class="fas fa-broom" style="color: #f59e0b; margin-right: 10px;"></i>
                    Rekap Piket Umum Siswa
                </h3>
                <i class="fas fa-chevron-down accordion-icon" style="color: #9ca3af;"></i>
            </div>
            
            <div class="accordion-content">
            
            <!-- Stats Cards for Piket (Moved inside content) -->
            <div class="stats-grid">
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <div class="stat-info">
                        <h3 id="rekapPiketYa">0</h3>
                        <p>Melaksanakan</p>
                    </div>
                    <i class="fas fa-check-circle stat-icon" style="color: #10b981;"></i>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ef4444;">
                    <div class="stat-info">
                        <h3 id="rekapPiketTidak">0</h3>
                        <p>Tidak Melaksanakan</p>
                    </div>
                    <i class="fas fa-times-circle stat-icon" style="color: #ef4444;"></i>
                </div>
            </div>

            <!-- Search and Export for Piket -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                 <div style="display: flex; gap: 10px;">
                    <button id="exportPiketPdfBtn" class="btn-export"><i class="fas fa-file-pdf"></i> Export PDF</button>
                </div>
                <div>
                    <input type="text" id="searchPiketInput" placeholder="Cari Nama / Status / Tanggal..." style="padding: 8px; border: 1px solid #374151; border-radius: 4px; width: 250px; background-color: #111827; color: white;">
                </div>
            </div>

            <div class="table-responsive">
                <table class="custom-table" id="piketTable">
                    <thead>
                        <tr>
                            <th style="background-color: #3b82f6; color: white;">No</th>
                            <th style="background-color: #3b82f6; color: white;">Tanggal</th>
                            <th style="background-color: #3b82f6; color: white;">Nama Siswa</th>
                            <th style="background-color: #3b82f6; color: white;">Area Piket</th>
                            <th style="text-align: center; background-color: #3b82f6; color: white;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center;">Memuat data piket...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            </div>
        </div>

            <!-- 4. Rekap Nilai Mata Pelajaran -->
            <div class="accordion-item" id="nilaiKelasItem">
                <div class="card-header-dark accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                    <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                        <i class="fas fa-chart-line" style="color: #8b5cf6; margin-right: 10px;"></i>
                        Rekap Nilai Mata Pelajaran
                    </h3>
                    <i class="fas fa-chevron-down accordion-icon" style="color: #9ca3af;"></i>
                </div>
                
                <div class="accordion-content">
                    <!-- Preview Cards for Nilai -->
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        <div class="stat-card" style="border-left: 4px solid #ef4444; display: block; height: auto;">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #ef4444; border-bottom: 1px solid #374151; padding-bottom: 5px;">Daftar Siswa Belum Tuntas Nilai Harian</h4>
                            <div id="listBelumTuntasNH" style="font-size: 0.85rem; color: #cbd5e1; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid #f59e0b; display: block; height: auto;">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #f59e0b; border-bottom: 1px solid #374151; padding-bottom: 5px;">Daftar Siswa Belum Tuntas UTS</h4>
                            <div id="listBelumTuntasUTS" style="font-size: 0.85rem; color: #cbd5e1; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid #8b5cf6; display: block; height: auto;">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #8b5cf6; border-bottom: 1px solid #374151; padding-bottom: 5px;">Daftar Siswa Belum Tuntas US</h4>
                            <div id="listBelumTuntasUS" style="font-size: 0.85rem; color: #cbd5e1; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                        <div class="stat-card" style="border-left: 4px solid #ec4899; display: block; height: auto;">
                            <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: #ec4899; border-bottom: 1px solid #374151; padding-bottom: 5px;">Daftar Siswa Belum Tuntas Nilai Raport</h4>
                            <div id="listBelumTuntasNR" style="font-size: 0.85rem; color: #cbd5e1; max-height: 150px; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- Filter & Search Section for Nilai -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; margin-top: 20px; border-top: 1px solid #374151; padding-top: 20px;">
                        <div style="display: flex; gap: 10px; flex: 1; flex-wrap: wrap;">
                             <select id="filterMapelNilai" style="padding: 8px; border: 1px solid #374151; border-radius: 4px; min-width: 200px; background-color: #111827; color: white;">
                                <option value="">Semua Mata Pelajaran</option>
                             </select>
                             <input type="text" id="searchNilaiInput" placeholder="Cari Nama / Mapel / Status..." style="padding: 8px; border: 1px solid #374151; border-radius: 4px; flex: 1; background-color: #111827; color: white; min-width: 200px;">
                        </div>
                        <button id="exportNilaiPdfBtn" class="btn-export"><i class="fas fa-file-pdf"></i> Export PDF</button>
                    </div>

                    <div class="table-responsive">
                        <table class="custom-table" id="nilaiTable">
                            <thead>
                                <tr>
                                    <th style="background-color: #3b82f6; color: white;">No</th>
                                    <th style="background-color: #3b82f6; color: white;">Nama Siswa</th>
                                    <th style="background-color: #3b82f6; color: white;">Mata Pelajaran</th>
                                    <th style="background-color: #3b82f6; color: white;">Semester</th>
                                    <th style="text-align: center; background-color: #3b82f6; color: white;">Nilai Akhir (NR)</th>
                                    <th style="text-align: center; background-color: #3b82f6; color: white;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align: center;">Memuat data nilai...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. Kasus Kelas -->
            <div class="accordion-item" id="kasusKelasItem">
                <div class="card-header-dark accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; padding: 20px;">
                    <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center;">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444; margin-right: 10px;"></i>
                        Kasus Kelas
                    </h3>
                    <i class="fas fa-chevron-down accordion-icon" style="color: #9ca3af;"></i>
                </div>
                
                <div class="accordion-content">
                    <!-- Search and Export for Kasus -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                         <div style="display: flex; gap: 10px;">
                            <button id="exportKasusPdfBtn" class="btn-export"><i class="fas fa-file-pdf"></i> Export PDF</button>
                        </div>
                        <div>
                            <input type="text" id="searchKasusInput" placeholder="Cari Nama Siswa..." style="padding: 8px; border: 1px solid #374151; border-radius: 4px; width: 250px; background-color: #111827; color: white;">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="custom-table" id="kasusTable">
                            <thead>
                                <tr>
                                    <th style="background-color: #3b82f6; color: white;">No</th>
                                    <th style="background-color: #3b82f6; color: white;">Tanggal</th>
                                    <th style="background-color: #3b82f6; color: white;">Nama Siswa</th>
                                    <th style="background-color: #3b82f6; color: white;">Jenis Kasus</th>
                                    <th style="background-color: #3b82f6; color: white;">Pelapor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="5" style="text-align: center;">Memuat data kasus...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <footer class="main-footer">
            <p>&copy; 2024 SMK Negeri 1 Simpang Teritip. All rights reserved.</p>
            <p>Dikembangkan oleh Tim IT Sekolah.</p>
        </footer>
    </main>

    <!-- Modal Peringatan Walikelas (Just in case) -->
    <div id="walikelasWarningModal" class="modal">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-exclamation-circle" style="font-size: 4rem; color: #f59e0b;"></i>
            </div>
            <h3 style="color: #333; margin-bottom: 10px;">Akses Ditolak</h3>
            <p style="color: #666; margin-bottom: 25px;">Maaf, anda tidak memiliki tugas tambahan sebagai walikelas...!</p>
            <button onclick="document.getElementById('walikelasWarningModal').classList.remove('active')" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; width: 100%;">Tutup</button>
        </div>
    </div>

    <script>
        // --- Supabase Integration for Navbar ---
        const supabaseUrl = 'https://mjvobqfcoutazqcovtlp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1qdm9icWZjb3V0YXpxY292dGxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzEwMzYsImV4cCI6MjA4NjE0NzAzNn0.jz6JaC9mMTMhLVhXSh1OCnFWDPZ0Cy2tUnHEmWxAR8o';
        
        // --- Supabase Integration for Absensi (Mapping Siswa) ---
        const absensiUrl = 'https://ctbskvysuqecnaopqlam.supabase.co';
        const absensiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0YnNrdnlzdXFlY25hb3BxbGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5NTAwODksImV4cCI6MjA4NjUyNjA4OX0.npr4SV6s8XFxXek0R0jNvdhlnIZrdTqrNvWGYVtMAcY';
        
        let supabaseClient;
        let absensiClient;

        if (typeof supabase !== 'undefined') {
            supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            absensiClient = supabase.createClient(absensiUrl, absensiKey);

            async function loadSchoolIdentity() {
                try {
                    const { data, error } = await supabaseClient
                        .from('identitassekolah')
                        .select('nama_sekolah, logo')
                        .limit(1)
                        .single();
                    
                    if (data) {
                        if (data.nama_sekolah) {
                            document.querySelector('.navbar-brand span').textContent = data.nama_sekolah;
                        }
                        if (data.logo) {
                            const img = document.querySelector('.navbar-brand img');
                            img.src = data.logo;
                            img.style.display = 'block';
                        }
                    }
                } catch (err) {
                    console.error("Error loading school identity:", err);
                }
            }
            document.addEventListener('DOMContentLoaded', loadSchoolIdentity);
        }

        // --- Load Data Guru dari Sesi Login ---
        document.addEventListener('DOMContentLoaded', async () => {
            const session = JSON.parse(sessionStorage.getItem('guru_session'));
            
            if (session) {
                // Cek apakah guru ini benar walikelas dan ambil kelasnya
                try {
                    // Fetch NIP as text explicitly to avoid numeric precision issues
                    const { data: guruData } = await supabaseClient
                        .from('dataguru')
                        .select('nip::text')
                        .eq('nama_guru', session.nama)
                        .maybeSingle();

                    const { data: waliData, error } = await supabaseClient
                        .from('walikelas')
                        .select('kelas')
                        .eq('nama_guru', session.nama)
                        .maybeSingle();

                    if (waliData) {
                        // Update Welcome Heading dengan Kelas
                        const welcomeHeading = document.getElementById('welcomeHeading');
                        if (welcomeHeading) welcomeHeading.textContent = `Selamat Datang, Walikelas ${waliData.kelas}!`;
                        
                        // Update Biodata
                        document.getElementById('biodataContainer').style.display = 'block';
                        document.getElementById('bioNama').textContent = session.nama || '-';
                        document.getElementById('bioNip').textContent = (guruData && guruData.nip) ? guruData.nip : (session.nip || '-');
                        document.getElementById('bioKelas').textContent = waliData.kelas || '-';
                        
                        // Load Data Siswa berdasarkan Kelas
                        loadSiswaKelas(waliData.kelas);
                        loadAbsensiKelas(waliData.kelas);
                        loadPiketKelas(waliData.kelas);
                        loadNilaiKelas(waliData.kelas);
                        loadKasusKelas(waliData.kelas);
                        loadMapelOptions(waliData.kelas);

                        const photoEl = document.getElementById('bioPhoto');
                        if (session.photo) {
                            photoEl.src = session.photo;
                        } else {
                            photoEl.src = 'https://via.placeholder.com/120?text=No+Photo'; 
                        }
                    } else {
                        // Jika bukan walikelas, redirect atau tampilkan warning
                        alert("Anda tidak terdaftar sebagai Walikelas.");
                        window.location.href = 'adminguru.html';
                    }
                } catch (err) {
                    console.error("Error checking walikelas status:", err);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        // --- Load Data Siswa Kelas ---
        async function loadSiswaKelas(kelas) {
            const container = document.getElementById('mainAccordionContainer');
            const title = document.getElementById('kelasTitle');
            const totalEl = document.getElementById('totalSiswa');
            const tbody = document.querySelector('#siswaTable tbody');

            if(title) title.textContent = kelas;
            if(container) container.style.display = 'block'; // Show main accordion

            try {
                const { data, error } = await absensiClient
                    .from('mappingsiswa')
                    .select('*')
                    .eq('kelas', kelas)
                    .order('nama_siswa', { ascending: true });

                if (error) throw error;

                if (data) {
                    if(totalEl) totalEl.textContent = data.length;
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Tidak ada data siswa di kelas ini.</td></tr>';
                        return;
                    }

                    data.forEach((siswa, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${siswa.nama_siswa}</td>
                            <td>${siswa.nisn || '-'}</td>
                            <td>${siswa.alamat || '-'}</td>
                            <td style="text-align: center;">
                                <button class="btn-sm-export" onclick="exportLaporanSiswa(this, '${siswa.nisn || ''}', '${siswa.nama_siswa.replace(/'/g, "\\'")}', '${siswa.kelas}')" title="Export Laporan Siswa">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (err) {
                console.error("Error loading siswa:", err);
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Gagal memuat data: ${err.message}</td></tr>`;
            }
        }

        // --- Load Data Absensi Kelas ---
        async function loadAbsensiKelas(kelas) {
            const tbody = document.querySelector('#absensiTable tbody');

            try {
                // 1. Ambil semua siswa di kelas (untuk memastikan semua siswa terlist)
                const { data: students, error: studentError } = await absensiClient
                    .from('mappingsiswa')
                    .select('nama_siswa')
                    .eq('kelas', kelas)
                    .order('nama_siswa', { ascending: true });
                
                if (studentError) throw studentError;

                // 2. Ambil data absensi untuk kelas ini
                const { data: attendance, error: attendanceError } = await absensiClient
                    .from('absensiswa')
                    .select('nama_siswa, status_kehadiran')
                    .eq('kelas', kelas);

                if (attendanceError) throw attendanceError;

                // 3. Agregasi data
                const stats = {};
                // Global counters for cards
                let totalHadir = 0, totalSakit = 0, totalIjin = 0, totalAlpa = 0;
                
                // Inisialisasi stats untuk semua siswa
                if (students) {
                    students.forEach(s => {
                        stats[s.nama_siswa] = { Hadir: 0, Sakit: 0, Ijin: 0, Alpa: 0 };
                    });
                }

                // Hitung absensi
                if (attendance) {
                    attendance.forEach(record => {
                        const name = record.nama_siswa;
                        let status = record.status_kehadiran;
                        
                        if (!stats[name]) {
                            stats[name] = { Hadir: 0, Sakit: 0, Ijin: 0, Alpa: 0 };
                        }

                        // Normalisasi status
                        if (status === 'Izin') status = 'Ijin';
                        if (status === 'Alpha') status = 'Alpa';

                        if (stats[name][status] !== undefined) {
                            stats[name][status]++;
                            
                            // Update global counters
                            if (status === 'Hadir') totalHadir++;
                            else if (status === 'Sakit') totalSakit++;
                            else if (status === 'Ijin') totalIjin++;
                            else if (status === 'Alpa') totalAlpa++;
                        }
                    });
                }
                
                document.getElementById('rekapHadir').textContent = totalHadir;
                document.getElementById('rekapSakit').textContent = totalSakit;
                document.getElementById('rekapIjin').textContent = totalIjin;
                document.getElementById('rekapAlpa').textContent = totalAlpa;

                // 4. Render Tabel
                tbody.innerHTML = '';
                if (Object.keys(stats).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Belum ada data absensi.</td></tr>';
                    return;
                }

                // Urutkan berdasarkan nama
                const sortedNames = Object.keys(stats).sort();

                sortedNames.forEach((name, index) => {
                    const s = stats[name];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${name}</td>
                        <td style="text-align: center;"><span class="badge bg-success">${s.Hadir}</span></td>
                        <td style="text-align: center;"><span class="badge bg-info">${s.Sakit}</span></td>
                        <td style="text-align: center;"><span class="badge bg-warning">${s.Ijin}</span></td>
                        <td style="text-align: center;"><span class="badge bg-danger">${s.Alpa}</span></td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (err) {
                console.error("Error loading absensi:", err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Gagal memuat data: ${err.message}</td></tr>`;
            }
        }

        // --- Load Data Piket Kelas ---
        async function loadPiketKelas(kelas) {
            const tbody = document.querySelector('#piketTable tbody');

            try {
                const { data, error } = await supabaseClient
                    .from('jurnalpiket')
                    .select('*')
                    .eq('kelas', kelas)
                    .order('tanggal', { ascending: false });

                if (error) throw error;

                tbody.innerHTML = '';
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada data piket.</td></tr>';
                    return;
                }
                
                let totalYa = 0;
                let totalTidak = 0;

                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    let formattedDate = item.tanggal;
                    if (item.tanggal) {
                        const dateObj = new Date(item.tanggal);
                        formattedDate = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                    }

                    let statusBadge;
                    if (item.status === 'Ya') {
                        statusBadge = '<span class="badge bg-success">Melaksanakan</span>';
                        totalYa++;
                    } else {
                        statusBadge = '<span class="badge bg-danger">Tidak Melaksanakan</span>';
                        totalTidak++;
                    }
                    
                    row.innerHTML = `
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${formattedDate}</td>
                        <td>${item.nama_siswa}</td>
                        <td>${item.area}</td>
                        <td style="text-align: center;">${statusBadge}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('rekapPiketYa').textContent = totalYa;
                document.getElementById('rekapPiketTidak').textContent = totalTidak;

            } catch (err) {
                console.error("Error loading piket:", err);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Gagal memuat data: ${err.message}</td></tr>`;
            }
        }

        // --- Load Data Nilai Kelas ---
        async function loadNilaiKelas(kelas) {
            const tbody = document.querySelector('#nilaiTable tbody');
            
            // Elements for preview lists
            const listNH = document.getElementById('listBelumTuntasNH');
            const listUTS = document.getElementById('listBelumTuntasUTS');
            const listUS = document.getElementById('listBelumTuntasUS');
            const listNR = document.getElementById('listBelumTuntasNR');

            if(listNH) listNH.innerHTML = '<div style="color: #6b7280;">Memuat...</div>';
            if(listUTS) listUTS.innerHTML = '<div style="color: #6b7280;">Memuat...</div>';
            if(listUS) listUS.innerHTML = '<div style="color: #6b7280;">Memuat...</div>';
            if(listNR) listNR.innerHTML = '<div style="color: #6b7280;">Memuat...</div>';
            
            try {
                const { data, error } = await absensiClient
                    .from('nilaimapel')
                    .select('*')
                    .eq('kelas', kelas)
                    .order('nama_siswa', { ascending: true });

                if (error) throw error;

                tbody.innerHTML = '';
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Belum ada data nilai.</td></tr>';
                    if(listNH) listNH.innerHTML = '-';
                    if(listUTS) listUTS.innerHTML = '-';
                    if(listUS) listUS.innerHTML = '-';
                    if(listNR) listNR.innerHTML = '-';
                    return;
                }

                // Arrays to hold non-compliant students
                const belumTuntasNH = [];
                const belumTuntasUTS = [];
                const belumTuntasUS = [];
                const belumTuntasNR = [];

                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const statusColor = item.status === 'Tuntas' ? '#10b981' : '#ef4444';
                    
                    // Check thresholds
                    const kktp = parseFloat(item.kktp) || 0;
                    const nh = parseFloat(item.nh);
                    const uts = parseFloat(item.uts);
                    const us = parseFloat(item.us);
                    const nr = parseFloat(item.nr);

                    if (!isNaN(nh) && nh < kktp) belumTuntasNH.push(`${item.nama_siswa} (${item.mapel})`);
                    if (!isNaN(uts) && uts < kktp) belumTuntasUTS.push(`${item.nama_siswa} (${item.mapel})`);
                    if (!isNaN(us) && us < kktp) belumTuntasUS.push(`${item.nama_siswa} (${item.mapel})`);
                    if ((!isNaN(nr) && nr < kktp) || item.status === 'Tidak Tuntas') belumTuntasNR.push(`${item.nama_siswa} (${item.mapel})`);
                    
                    row.innerHTML = `
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${item.nama_siswa}</td>
                        <td>${item.mapel}</td>
                        <td>${item.semester || '-'}</td>
                        <td style="text-align: center;">${item.nr || '-'}</td>
                        <td style="text-align: center;"><span class="badge" style="background-color: ${statusColor};">${item.status || '-'}</span></td>
                    `;
                    tbody.appendChild(row);
                });

                // Populate Preview Lists
                const populateList = (element, list) => {
                    if (!element) return;
                    if (list.length === 0) {
                        element.innerHTML = '<div style="color: #10b981;">Semua Tuntas</div>';
                    } else {
                        element.innerHTML = list.map(s => `<div style="margin-bottom: 4px; border-bottom: 1px solid #374151; padding-bottom: 2px;">${s}</div>`).join('');
                    }
                };

                populateList(listNH, belumTuntasNH);
                populateList(listUTS, belumTuntasUTS);
                populateList(listUS, belumTuntasUS);
                populateList(listNR, belumTuntasNR);

            } catch (err) {
                console.error("Error loading nilai:", err);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Gagal memuat data: ${err.message}</td></tr>`;
            }
        }

        // --- Load Mapel Options for Filter ---
        async function loadMapelOptions(kelas) {
            const select = document.getElementById('filterMapelNilai');
            if (!select) return;

            try {
                const { data, error } = await absensiClient
                    .from('matapelajaran')
                    .select('nama_mapel')
                    .order('nama_mapel', { ascending: true });

                if (error) throw error;

                if (data) {
                    const uniqueMapels = [...new Set(data.map(item => item.nama_mapel))];
                    select.innerHTML = '<option value="">Semua Mata Pelajaran</option>';
                    uniqueMapels.forEach(mapel => {
                        const option = document.createElement('option');
                        option.value = mapel;
                        option.textContent = mapel;
                        select.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("Error loading mapel options:", err);
            }
        }

        // --- Load Data Kasus Kelas ---
        async function loadKasusKelas(kelas) {
            const tbody = document.querySelector('#kasusTable tbody');
            
            try {
                const { data, error } = await absensiClient
                    .from('kasussiswa')
                    .select('*')
                    .eq('kelas', kelas)
                    .order('tanggal', { ascending: false });

                if (error) throw error;

                tbody.innerHTML = '';
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Belum ada data kasus.</td></tr>';
                    return;
                }

                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="text-align: center;">${index + 1}</td>
                        <td>${item.tanggal}</td>
                        <td>${item.nama_siswa}</td>
                        <td>${item.jenis_kasus}</td>
                        <td>${item.nama_guru || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                console.error("Error loading kasus:", err);
                tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">Gagal memuat data: ${err.message}</td></tr>`;
            }
        }

        // --- Search Absensi ---
        document.getElementById('searchAbsensiInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#absensiTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 6) return; // Skip baris kosong/loading

                const name = cells[1].textContent.toLowerCase();
                const hadir = parseInt(cells[2].textContent) || 0;
                const sakit = parseInt(cells[3].textContent) || 0;
                const ijin = parseInt(cells[4].textContent) || 0;
                const alpa = parseInt(cells[5].textContent) || 0;

                let match = false;

                if (term === 'hadir') match = hadir > 0;
                else if (term === 'sakit') match = sakit > 0;
                else if (term === 'ijin' || term === 'izin') match = ijin > 0;
                else if (term === 'alpa' || term === 'alpha') match = alpa > 0;
                else {
                    match = name.includes(term);
                }

                row.style.display = match ? '' : 'none';
            });
        });

        // --- Search Piket ---
        document.getElementById('searchPiketInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#piketTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 5) return;

                const dateText = cells[1].textContent.toLowerCase();
                const name = cells[2].textContent.toLowerCase();
                const statusText = cells[4].textContent.toLowerCase(); // "Melaksanakan" or "Tidak Melaksanakan"

                let match = false;
                
                // Logika pencarian khusus untuk status
                if (term === 'melaksanakan') {
                    // Jika user ketik "melaksanakan", tampilkan yang statusnya "Melaksanakan" (bukan "Tidak Melaksanakan")
                    // Namun karena "Tidak Melaksanakan" mengandung kata "Melaksanakan", kita perlu cek negatifnya
                    match = statusText.includes('melaksanakan') && !statusText.includes('tidak');
                } else if (term === 'tidak' || term === 'tidak melaksanakan') {
                    match = statusText.includes('tidak');
                } else {
                    // Pencarian umum (Nama atau Status)
                    match = name.includes(term) || statusText.includes(term) || dateText.includes(term);
                }

                row.style.display = match ? '' : 'none';
            });
        });

        // --- Filter Nilai Logic ---
        function filterNilaiTable() {
            const mapelFilter = document.getElementById('filterMapelNilai').value.toLowerCase();
            const searchFilter = document.getElementById('searchNilaiInput').value.toLowerCase();
            const rows = document.querySelectorAll('#nilaiTable tbody tr');

            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 6) return;

                const nama = cells[1].textContent.toLowerCase();
                const mapel = cells[2].textContent.toLowerCase();
                const status = cells[5].textContent.toLowerCase();

                const matchesMapel = !mapelFilter || mapel === mapelFilter;
                const matchesSearch = !searchFilter || nama.includes(searchFilter) || mapel.includes(searchFilter) || status.includes(searchFilter);

                row.style.display = (matchesMapel && matchesSearch) ? '' : 'none';
            });
        }

        document.getElementById('filterMapelNilai').addEventListener('change', filterNilaiTable);
        document.getElementById('searchNilaiInput').addEventListener('input', filterNilaiTable);

        // --- Export PDF Piket ---
        document.getElementById('exportPiketPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const kelas = document.getElementById('kelasTitle').textContent || 'Kelas';
            
            doc.setFontSize(18);
            doc.text(`Rekap Piket Umum Siswa - Kelas ${kelas}`, 14, 22);
            
            const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(schoolName, 14, 30);

            doc.autoTable({
                html: '#piketTable',
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: { 0: { halign: 'center' }, 4: { halign: 'center' } }
            });

            doc.save(`Rekap_Piket_${kelas}.pdf`);
        });

        // --- Export PDF Absensi ---
        document.getElementById('exportAbsensiPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const kelas = document.getElementById('kelasTitle').textContent || 'Kelas';
            
            doc.setFontSize(18);
            doc.text(`Rekap Absensi Siswa - Kelas ${kelas}`, 14, 22);
            
            const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(schoolName, 14, 30);

            doc.autoTable({
                html: '#absensiTable',
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: { 0: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' }, 4: { halign: 'center' }, 5: { halign: 'center' } }
            });

            doc.save(`Rekap_Absensi_${kelas}.pdf`);
        });

        // --- Export PDF Nilai ---
        document.getElementById('exportNilaiPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const kelas = document.getElementById('kelasTitle').textContent || 'Kelas';
            
            doc.setFontSize(18);
            doc.text(`Rekap Nilai Siswa - Kelas ${kelas}`, 14, 22);
            
            const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(schoolName, 14, 30);

            doc.autoTable({
                html: '#nilaiTable',
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: { 0: { halign: 'center' }, 4: { halign: 'center' }, 5: { halign: 'center' } }
            });

            doc.save(`Rekap_Nilai_${kelas}.pdf`);
        });

        // --- Search Kasus Logic ---
        document.getElementById('searchKasusInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase().trim();
            const rows = document.querySelectorAll('#kasusTable tbody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                if (cells.length < 5) return;

                const name = cells[2].textContent.toLowerCase();
                const match = name.includes(term);

                row.style.display = match ? '' : 'none';
            });
        });

        // --- Export PDF Kasus ---
        document.getElementById('exportKasusPdfBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const kelas = document.getElementById('kelasTitle').textContent || 'Kelas';
            
            doc.setFontSize(18);
            doc.text(`Laporan Kasus Siswa - Kelas ${kelas}`, 14, 22);
            
            const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(schoolName, 14, 30);

            doc.autoTable({
                html: '#kasusTable',
                startY: 40,
                theme: 'grid',
                headStyles: { fillColor: [239, 68, 68] }, // Red header for Kasus
                styles: { fontSize: 10, cellPadding: 3 },
                columnStyles: { 0: { halign: 'center' } }
            });

            doc.save(`Laporan_Kasus_${kelas}.pdf`);
        });

        // --- Export Laporan Perkembangan Peserta Didik (Lengkap) ---
        document.getElementById('exportLaporanLengkapBtn').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            
            const kelas = document.getElementById('kelasTitle').textContent || 'Kelas';
            const namaWalikelas = document.getElementById('bioNama').textContent;
            const nipWalikelas = document.getElementById('bioNip').textContent;
            const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
            
            let yPos = 20;

            // --- Header ---
            doc.setFontSize(16);
            doc.text("Laporan Perkembangan Peserta Didik", pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(schoolName, pageWidth / 2, yPos, { align: 'center' });
            yPos += 10;
            doc.setTextColor(0);
            doc.setFontSize(10);
            doc.text(`Kelas: ${kelas}`, 14, yPos);
            doc.text(`Walikelas: ${namaWalikelas}`, 14, yPos + 5);
            yPos += 15;

            // --- 1. Rekap Absensi ---
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("1. Rekap Absensi Siswa", 14, yPos);
            yPos += 7;
            
            // Stats Absensi
            const hadir = document.getElementById('rekapHadir').textContent;
            const sakit = document.getElementById('rekapSakit').textContent;
            const ijin = document.getElementById('rekapIjin').textContent;
            const alpa = document.getElementById('rekapAlpa').textContent;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Ringkasan: Hadir (${hadir}) | Sakit (${sakit}) | Ijin (${ijin}) | Alpa (${alpa})`, 14, yPos);
            yPos += 5;

            doc.autoTable({
                html: '#absensiTable',
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [59, 130, 246] },
                styles: { fontSize: 9, cellPadding: 2 },
                margin: { left: 14, right: 14 }
            });
            yPos = doc.lastAutoTable.finalY + 15;

            // --- 2. Rekap Piket ---
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("2. Rekap Piket Umum Siswa", 14, yPos);
            yPos += 7;

            // Stats Piket
            const piketYa = document.getElementById('rekapPiketYa').textContent;
            const piketTidak = document.getElementById('rekapPiketTidak').textContent;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Ringkasan: Melaksanakan (${piketYa}) | Tidak Melaksanakan (${piketTidak})`, 14, yPos);
            yPos += 5;

            doc.autoTable({
                html: '#piketTable',
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [245, 158, 11] },
                styles: { fontSize: 9, cellPadding: 2 },
                margin: { left: 14, right: 14 }
            });
            yPos = doc.lastAutoTable.finalY + 15;

            // --- 3. Kasus Kelas ---
            if (yPos > 250) { doc.addPage(); yPos = 20; }

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("3. Kasus Kelas", 14, yPos);
            yPos += 7;

            doc.autoTable({
                html: '#kasusTable',
                startY: yPos,
                theme: 'grid',
                headStyles: { fillColor: [239, 68, 68] },
                styles: { fontSize: 9, cellPadding: 2 },
                margin: { left: 14, right: 14 }
            });
            yPos = doc.lastAutoTable.finalY + 25;

            // --- Tanda Tangan ---
            if (yPos > 250) { doc.addPage(); yPos = 20; }
            
            const today = new Date();
            const dateStr = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const xSig = pageWidth - 60;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Simpang Teritip, ${dateStr}`, xSig, yPos, { align: 'center' });
            doc.text("Walikelas,", xSig, yPos + 5, { align: 'center' });
            doc.text(namaWalikelas, xSig, yPos + 25, { align: 'center' });
            doc.text(`NIP. ${nipWalikelas}`, xSig, yPos + 30, { align: 'center' });

            doc.save(`Laporan_Perkembangan_Siswa_${kelas}.pdf`);
        });

        // --- Fitur Jam & Tanggal Berjalan ---
        function updateLiveTime() {
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('liveDateTime').textContent = `${now.toLocaleDateString('id-ID', dateOptions)} | ${now.toLocaleTimeString('id-ID', timeOptions).replace(/\./g, ':')} WIB`;
        }
        setInterval(updateLiveTime, 1000);
        updateLiveTime();

        // --- Load Statistik Piket Bulan Ini (Sama dengan adminguru.html) ---
        async function loadPiketStats() {
            const now = new Date();
            
            // 1. Set Bulan Display
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentMonthName = monthNames[now.getMonth()];
            const currentYear = now.getFullYear();
            const displayEl = document.getElementById('piketMonthDisplay');
            if(displayEl) displayEl.textContent = `${currentMonthName} ${currentYear}`;

            // 2. Count Petugas Piket Hari Ini
            const days = ['MINGGU', 'SENIN', 'SELASA', 'RABU', 'KAMIS', 'JUMAT', 'SABTU'];
            const todayName = days[now.getDay()];
            
            try {
                const { count, error } = await supabaseClient
                    .from('datapiketsiswa')
                    .select('*', { count: 'exact', head: true })
                    .ilike('id_piket', `ID_${todayName}%`);
                
                if (!error) {
                    const countEl = document.getElementById('countPetugasHariIni');
                    if(countEl) countEl.textContent = count || 0;
                }
            } catch (err) {
                console.error("Error counting petugas:", err);
            }

            // 3. Count Riwayat Piket Bulan Ini
            try {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

                const { data, error } = await supabaseClient
                    .from('jurnalpiket')
                    .select('status')
                    .gte('tanggal', startOfMonth)
                    .lte('tanggal', endOfMonth);

                if (!error && data) {
                    const melaksanakan = data.filter(d => d.status === 'Ya').length;
                    const tidakMelaksanakan = data.filter(d => d.status === 'Tidak').length;

                    const elYa = document.getElementById('countMelaksanakan');
                    const elTidak = document.getElementById('countTidakMelaksanakan');
                    
                    if(elYa) elYa.textContent = melaksanakan;
                    if(elTidak) elTidak.textContent = tidakMelaksanakan;
                }
            } catch (err) {
                console.error("Error counting jurnal:", err);
            }
        }

        // --- Accordion Logic ---
        function toggleAccordion(header) {
            const item = header.parentElement;
            const container = document.getElementById('mainAccordionContainer');
            const allItems = container.querySelectorAll('.accordion-item');
            const content = item.querySelector('.accordion-content');
            const isOpen = item.classList.contains('active');

            // Close all other items
            allItems.forEach(otherItem => {
                if (otherItem !== item && otherItem.classList.contains('active')) {
                    const otherContent = otherItem.querySelector('.accordion-content');
                    // Set fixed height to enable transition from 'none'
                    if (otherContent.style.maxHeight === 'none') {
                        otherContent.style.maxHeight = otherContent.scrollHeight + "px";
                    }
                    setTimeout(() => {
                        otherItem.classList.remove('active');
                        otherContent.style.maxHeight = null;
                    }, 10);
                }
            });

            // Toggle clicked item
            if (isOpen) {
                if (content.style.maxHeight === 'none') {
                    content.style.maxHeight = content.scrollHeight + "px";
                }
                setTimeout(() => {
                    item.classList.remove('active');
                    content.style.maxHeight = null;
                }, 10);
            } else {
                item.classList.add('active');
                content.style.maxHeight = (content.scrollHeight + 40) + "px"; // +40 for padding
                
                content.addEventListener('transitionend', function() {
                    if (item.classList.contains('active')) {
                        content.style.maxHeight = 'none';
                    }
                }, { once: true });
            }
        }

        // --- Export Laporan Per Siswa (Individual) ---
        window.exportLaporanSiswa = async function(btn, nisn, nama, kelas) {
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const pageWidth = doc.internal.pageSize.width;

                // 1. Fetch Data Spesifik Siswa secara Paralel
                const pAbsensi = absensiClient.from('absensiswa').select('status_kehadiran').eq('nama_siswa', nama).eq('kelas', kelas);
                const pNilai = absensiClient.from('nilaimapel').select('*').eq('nama_siswa', nama).eq('kelas', kelas);
                const pKasus = absensiClient.from('kasussiswa').select('*').eq('nama_siswa', nama).eq('kelas', kelas);
                const pPiket = supabaseClient.from('jurnalpiket').select('*').eq('nama_siswa', nama).eq('kelas', kelas).order('tanggal', { ascending: false });

                const [resAbsensi, resNilai, resKasus, resPiket] = await Promise.all([pAbsensi, pNilai, pKasus, pPiket]);

                // 2. Header PDF
                const schoolName = document.querySelector('.navbar-brand span').textContent || 'SMK Negeri 1 Simpang Teritip';
                doc.setFontSize(16);
                doc.text("Laporan Kemajuan Siswa", pageWidth / 2, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text(schoolName, pageWidth / 2, 28, { align: 'center' });
                doc.setTextColor(0);

                // Biodata Singkat
                doc.setFontSize(10);
                doc.text(`Nama: ${nama}`, 14, 40);
                doc.text(`NISN: ${nisn || '-'}`, 14, 45);
                doc.text(`Kelas: ${kelas}`, 14, 50);
                
                let yPos = 60;

                // 3. Data Absensi
                const stats = { Hadir: 0, Sakit: 0, Ijin: 0, Alpa: 0 };
                if (resAbsensi.data) {
                    resAbsensi.data.forEach(r => {
                        let s = r.status_kehadiran;
                        if (s === 'Izin') s = 'Ijin';
                        if (s === 'Alpha') s = 'Alpa';
                        if (stats[s] !== undefined) stats[s]++;
                    });
                }

                doc.setFont(undefined, 'bold');
                doc.text("A. Kehadiran", 14, yPos);
                yPos += 5;
                
                const absensiData = [['Hadir', 'Sakit', 'Ijin', 'Alpa'], [stats.Hadir, stats.Sakit, stats.Ijin, stats.Alpa]];
                doc.autoTable({
                    head: absensiData.slice(0,1),
                    body: absensiData.slice(1),
                    startY: yPos,
                    theme: 'grid',
                    headStyles: { fillColor: [16, 185, 129] },
                    styles: { halign: 'center' },
                    margin: { left: 14, right: 14 }
                });
                yPos = doc.lastAutoTable.finalY + 15;

                // 4. Data Nilai
                doc.setFont(undefined, 'bold');
                doc.text("B. Nilai Akademis", 14, yPos);
                yPos += 5;

                const nilaiRows = (resNilai.data || []).map((n, i) => [
                    i + 1, n.mapel, n.kktp || '-', n.nh || '-', n.uts || '-', n.us || '-', n.nr || '-', n.status || '-'
                ]);

                if (nilaiRows.length === 0) nilaiRows.push(['-', 'Belum ada data nilai', '-', '-', '-', '-', '-', '-']);

                doc.autoTable({
                    head: [['No', 'Mata Pelajaran', 'KKTP', 'NH', 'UTS', 'US', 'NR', 'Status']],
                    body: nilaiRows,
                    startY: yPos,
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] },
                    styles: { fontSize: 9 },
                    margin: { left: 14, right: 14 }
                });
                yPos = doc.lastAutoTable.finalY + 15;

                // 5. Data Piket (Rekap Piket Umum)
                if (yPos > 250) { doc.addPage(); yPos = 20; }
                doc.setFont(undefined, 'bold');
                doc.text("C. Riwayat Piket Umum", 14, yPos);
                yPos += 5;

                const piketStats = { Ya: 0, Tidak: 0 };
                const piketRows = (resPiket.data || []).map((p, i) => {
                    if (p.status === 'Ya') piketStats.Ya++;
                    else piketStats.Tidak++;
                    
                    let dateStr = p.tanggal;
                    if (p.tanggal) {
                        const d = new Date(p.tanggal);
                        dateStr = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
                    }
                    return [i + 1, dateStr, p.area, p.status];
                });

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Ringkasan: Melaksanakan (${piketStats.Ya}) | Tidak Melaksanakan (${piketStats.Tidak})`, 14, yPos);
                yPos += 5;

                if (piketRows.length > 0) {
                    doc.autoTable({
                        head: [['No', 'Tanggal', 'Area Piket', 'Status']],
                        body: piketRows,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [245, 158, 11] },
                        styles: { fontSize: 9 },
                        margin: { left: 14, right: 14 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                } else {
                    doc.text("Belum ada data piket.", 14, yPos);
                    yPos += 10;
                }

                // 6. Data Kasus (Jika ada)
                if (resKasus.data && resKasus.data.length > 0) {
                    if (yPos > 250) { doc.addPage(); yPos = 20; }
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(239, 68, 68);
                    doc.text("D. Catatan Kasus/Pelanggaran", 14, yPos);
                    doc.setTextColor(0);
                    yPos += 5;

                    const kasusRows = resKasus.data.map((k, i) => [i+1, k.tanggal, k.jenis_kasus, k.nama_guru || '-']);
                    doc.autoTable({
                        head: [['No', 'Tanggal', 'Jenis Kasus', 'Pelapor']],
                        body: kasusRows,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [239, 68, 68] },
                        margin: { left: 14, right: 14 }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                // 7. Tanda Tangan Walikelas
                if (yPos > 240) { doc.addPage(); yPos = 20; }
                
                const today = new Date();
                const dateStr = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                
                // Ambil data walikelas dari elemen biodata (yang sudah di-load saat login)
                const guruNama = document.getElementById('bioNama').textContent || '.........................';
                const guruNip = document.getElementById('bioNip').textContent || '.........................';

                const xPos = pageWidth - 60; // Posisi kanan

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0);
                
                doc.text(`Simpang Teritip, ${dateStr}`, xPos, yPos, { align: 'center' });
                doc.text("Walikelas,", xPos, yPos + 5, { align: 'center' });
                
                doc.setFont(undefined, 'bold');
                doc.text(guruNama, xPos, yPos + 25, { align: 'center' });
                doc.setFont(undefined, 'normal');
                doc.text(`NIP. ${guruNip}`, xPos, yPos + 30, { align: 'center' });

                doc.save(`Laporan_Siswa_${nama.replace(/\s+/g, '_')}.pdf`);

            } catch (err) {
                console.error("Export error:", err);
                alert("Gagal mengexport laporan: " + err.message);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        };

        document.addEventListener('DOMContentLoaded', loadPiketStats);

        // --- Walikelas Validation (Self Check) ---
        const walikelasLink = document.getElementById('walikelasLink');
        const walikelasWarningModal = document.getElementById('walikelasWarningModal');

        if (walikelasLink) {
            walikelasLink.addEventListener('click', async (e) => {
                e.preventDefault();
                // Already on the page, maybe refresh or do nothing
                // Or re-validate just in case
                const session = JSON.parse(sessionStorage.getItem('guru_session'));
                if (!session || !session.nama) {
                    alert("Sesi tidak valid. Silakan login ulang.");
                    return;
                }

                try {
                    const { data, error } = await supabaseClient
                        .from('walikelas')
                        .select('nama_guru')
                        .eq('nama_guru', session.nama)
                        .maybeSingle();

                    if (data) {
                        // Already here
                        alert("Anda sedang berada di halaman Walikelas.");
                    } else {
                        walikelasWarningModal.classList.add('active');
                    }
                } catch (err) {
                    console.error("Error validating walikelas:", err);
                }
            });
        }
    </script>
</body>
</html>
